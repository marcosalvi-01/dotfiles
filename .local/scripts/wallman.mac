#!/bin/sh
# change_wallpaper.sh
# This script selects a random wallpaper from a given directory,
# ensuring it hasnâ€™t been used recently. When all wallpapers have
# been used, it clears the history and starts over.

# Set the directory containing your wallpapers.
# Adjust this path as needed.
WALLPAPER_DIR="$HOME/.config/images/gruvbox/"

# Temp file to store the history of used wallpapers.
HISTORY_FILE="/tmp/wallpaper_history.txt"

# Check if the wallpaper directory exists.
if [ ! -d "$WALLPAPER_DIR" ]; then
    echo "Error: Wallpaper directory '$WALLPAPER_DIR' does not exist."
    exit 1
fi

# Create the history file if it doesn't exist.
if [ ! -f "$HISTORY_FILE" ]; then
    touch "$HISTORY_FILE"
fi

# Build an array of available wallpapers (files not yet used).
AVAILABLE=()
for f in "$WALLPAPER_DIR"/*; do
    # Only consider regular files.
    [ -f "$f" ] || continue
    # If the file is not in the history, add it.
    if ! grep -Fxq "$f" "$HISTORY_FILE"; then
        AVAILABLE+=("$f")
    fi
done

# If all wallpapers have been used, clear the history and reset the list.
if [ ${#AVAILABLE[@]} -eq 0 ]; then
    # Clear the history file.
    > "$HISTORY_FILE"
    # Repopulate AVAILABLE with all wallpapers.
    for f in "$WALLPAPER_DIR"/*; do
        [ -f "$f" ] || continue
        AVAILABLE+=("$f")
    done
fi

# Make sure there is at least one wallpaper available.
NUM_AVAILABLE=${#AVAILABLE[@]}
if [ "$NUM_AVAILABLE" -eq 0 ]; then
    echo "Error: No wallpaper files found in '$WALLPAPER_DIR'."
    exit 1
fi

# Select a random wallpaper.
RANDOM_INDEX=$(( RANDOM % NUM_AVAILABLE ))
CHOSEN="${AVAILABLE[$RANDOM_INDEX]}"

# Change the wallpaper using AppleScript.
osascript -e "tell application \"System Events\" to set picture of every desktop to \"$CHOSEN\""

# Append the chosen wallpaper to the history file.
echo "$CHOSEN" >> "$HISTORY_FILE"

echo "Wallpaper changed to: $CHOSEN"
